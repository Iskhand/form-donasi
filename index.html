<div>
  <div>
    <meta charset="UTF-8"></meta>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"></meta>
    <title>Form Pengaduan - BPR Cahaya Bumi Artha</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <!-- Add SweetAlert2 -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bootstrap-4/bootstrap-4.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
      /* Warna utama */
      :root {
        --primary-blue: #2980b9;
        --secondary-blue: #3498db;
        --light-blue: #ebf5fb;
        --primary-red: #e74c3c;
        --secondary-red: #c0392b;
        --light-red: #fdedec;
      }

      .bca-form-container {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif !important;
        max-width: 800px !important;
        margin: 40px auto !important;
        padding: 20px !important;
        background-color: #fff !important;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1) !important;
      }

      .bca-form-container .form-section {
        background-color: var(--light-blue) !important;
        padding: 25px !important;
        border-radius: 10px !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05) !important;
        margin-bottom: 30px !important;
        border-left: 5px solid var(--primary-blue) !important;
      }

      .bca-form-container h1 {
        color: var(--primary-blue) !important;
        text-align: center !important;
        margin-bottom: 30px !important;
        font-size: 2.2rem !important;
        font-weight: bold !important;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1) !important;
      }

      .bca-form-container h2 {
        color: var(--secondary-blue) !important;
        font-size: 1.5rem !important;
        margin-bottom: 20px !important;
        padding-bottom: 10px !important;
        border-bottom: 2px solid var(--secondary-blue) !important;
      }

      .bca-form-container .form-label {
        font-weight: 500 !important;
        color: #2c3e50 !important;
        margin-bottom: 0.5rem !important;
      }

      .bca-form-container .form-control {
        border: 2px solid #e8e8e8 !important;
        border-radius: 8px !important;
        padding: 10px 15px !important;
        transition: all 0.3s ease !important;
      }

      .bca-form-container .form-control:focus {
        border-color: var(--secondary-blue) !important;
        box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25) !important;
      }

      .bca-form-container .form-control.is-invalid {
        border-color: var(--primary-red) !important;
      }

      .bca-form-container #signature-pad {
        border: 2px solid #e8e8e8 !important;
        border-radius: 8px !important;
        background-color: #fff !important;
        width: 100% !important;
        max-width: 600px !important;
      }

      .bca-form-container .btn {
        padding: 12px 25px !important;
        border-radius: 8px !important;
        font-weight: 500 !important;
        transition: all 0.3s ease !important;
        text-transform: uppercase !important;
        letter-spacing: 0.5px !important;
      }

      .bca-form-container .btn-danger {
        background-color: var(--primary-red) !important;
        border: none !important;
        color: white !important;
      }

      .bca-form-container .btn-danger:hover {
        background-color: var(--secondary-red) !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 8px rgba(231, 76, 60, 0.2) !important;
      }

      .bca-form-container .btn-primary {
        background-color: var(--primary-blue) !important;
        border: none !important;
        color: white !important;
      }

      .bca-form-container .btn-primary:hover {
        background-color: var(--secondary-blue) !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 8px rgba(41, 128, 185, 0.2) !important;
      }

      /* Style untuk SweetAlert */
      .swal2-popup {
        border-radius: 15px !important;
      }

      .swal2-title {
        color: var(--primary-blue) !important;
      }

      .swal2-confirm {
        background-color: var(--primary-blue) !important;
      }

      .swal2-cancel {
        background-color: var(--primary-red) !important;
      }

      /* Hover effect pada form sections */
      .bca-form-container .form-section:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1) !important;
        transition: all 0.3s ease !important;
      }

      /* Style untuk required fields */
      .required-field::after {
        content: " *" !important;
        color: var(--primary-red) !important;
      }

      /* Style untuk file upload */
      .file-upload-wrapper {
        position: relative !important;
        padding: 20px !important;
        background-color: var(--light-blue) !important;
        border-radius: 8px !important;
        border: 2px dashed var(--secondary-blue) !important;
        text-align: center !important;
        transition: all 0.3s ease !important;
      }

      .file-upload-wrapper:hover {
        background-color: #f8f9fa !important;
        border-color: var(--primary-blue) !important;
      }
    </style>
  </div>
  <div>
    <!-- Add this iframe -->
    <iframe id="hidden_iframe" name="hidden_iframe" style="display: none;"></iframe>

    <div class="container bca-form-container">

      <form id="complaintForm" target="hidden_iframe">
        <!-- 1. Data Pribadi -->
        <div class="form-section">
          <h2>1. Data Pribadi</h2>
          <div class="mb-3">
            <label class="form-label required-field" for="fullName">Nama Lengkap</label>
            <input class="form-control" id="fullName" name="fullName" required="" type="text" />
          </div>
          <div class="mb-3">
            <label class="form-label" for="idNumber">Nomor Identitas (16 digit)</label>
            <input class="form-control" id="idNumber" maxlength="16" name="idNumber" type="text" />
          </div>
          <div class="mb-3">
            <label class="form-label " for="phone">No. HP (No. WA)</label>
            <input class="form-control" id="phone" name="phone" type="text" />
          </div>
          <div class="mb-3">
            <label class="form-label" for="email">Email</label>
            <input class="form-control" id="email" name="email" type="email" />
          </div>
          <div class="mb-3">
            <label class="form-label" for="accountNumber">Nomor Rekening (Opsional)</label>
            <input class="form-control" id="accountNumber" name="accountNumber" type="text" />
          </div>
        </div>

        <!-- 2. Alamat Sesuai Identitas -->
        <div class="form-section">
          <h2>2. Alamat Sesuai Identitas</h2>
          <div class="mb-3">
            <label class="form-label required-field" for="idAddress">Alamat Lengkap</label>
            <textarea class="form-control" id="idAddress" name="idAddress" required="" rows="3"></textarea>
          </div>
          <div class="row mb-3">
            <div class="col">
              <label class="form-label required-field" for="idRT">RT</label>
              <input class="form-control" id="idRT" name="idRT" required="" type="text" />
            </div>
            <div class="col">
              <label class="form-label required-field" for="idRW">RW</label>
              <input class="form-control" id="idRW" name="idRW" required="" type="text" />
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label required-field" for="idKelurahan">Kelurahan</label>
            <input class="form-control" id="idKelurahan" name="idKelurahan" required="" type="text" />
          </div>
          <div class="mb-3">
            <label class="form-label required-field" for="idKecamatan">Kecamatan</label>
            <input class="form-control" id="idKecamatan" name="idKecamatan" required="" type="text" />
          </div>
        </div>

        <!-- 3. Alamat Domisili -->
        <div class="form-section">
          <h2>3. Alamat Domisili</h2>
          <p class="text-muted">
            <em>(Jika berbeda dengan alamat sesuai identitas)</em>
          </p>
          <div class="mb-3">
            <label class="form-label" for="domAddress">Alamat Lengkap</label>
            <textarea class="form-control" id="domAddress" name="domAddress" rows="3"></textarea>
          </div>
          <div class="row mb-3">
            <div class="col">
              <label class="form-label" for="domRT">RT</label>
              <input class="form-control" id="domRT" name="domRT" type="text" />
            </div>
            <div class="col">
              <label class="form-label" for="domRW">RW</label>
              <input class="form-control" id="domRW" name="domRW" type="text" />
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label" for="domKelurahan">Kelurahan</label>
            <input class="form-control" id="domKelurahan" name="domKelurahan" type="text" />
          </div>
          <div class="mb-3">
            <label class="form-label" for="domKecamatan">Kecamatan</label>
            <input class="form-control" id="domKecamatan" name="domKecamatan" type="text" />
          </div>
        </div>

        <!-- 4. Informasi Pengaduan -->
        <div class="form-section">
          <h2>4. Informasi Pengaduan</h2>
          <div class="mb-3">
            <label class="form-label required-field" for="department">Bagian yang dituju</label>
            <input class="form-control" id="department" name="department" required="" type="text" placeholder="Misal : CS, Admin Kredit, Teller, Operasional, Akuntan, dll" />
          </div>
          <div class="mb-3">
            <label class="form-label required-field" for="product">Produk / Jasa</label>
            <input class="form-control" id="product" name="product" placeholder="Misal : Tabungan, Deposito, Kredit, dll" required="" type="text" />
          </div>
          <div class="mb-3">
            <label class="form-label required-field" for="complaint">Ringkasan Pengaduan</label>
            <textarea class="form-control" id="complaint" name="complaint" required="" rows="5"></textarea>
          </div>
        </div>

        <!-- 5. Lampiran Dokumen -->
        <div class="form-section">
          <h2>5. Lampiran Dokumen</h2>
          <div class="mb-3">
            <label class="form-label" for="requiredDoc">
              Dokumen Pendukung (PDF/JPG/PNG, max 5MB)
            </label>
            <input accept=".pdf,.jpg,.jpeg,.png" class="form-control" id="requiredDoc" name="requiredDoc" type="file" />
          </div>
          <div class="mb-3">
            <label class="form-label" for="additionalDoc">
              Dokumen Tambahan (PDF/JPG/PNG, max 5MB)
            </label>
            <input accept=".pdf,.jpg,.jpeg,.png" class="form-control" id="additionalDoc" name="additionalDoc" type="file" />
          </div>
        </div>

        <!-- 6. Tanda Tangan Digital -->
        <div class="form-section">
          <h2>6. Tanda Tangan Digital</h2>
          <canvas class="mb-3" height="200" id="signature-pad" width="400"></canvas>
          <div class="d-flex gap-2">
            <button class="btn btn-danger" id="clearSignature" type="button">
              Hapus Tanda Tangan
            </button>
            <button class="btn btn-primary" type="submit">Kirim</button>
          </div>
        </div>
      </form>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Signature Pad implementation
      const canvas = document.getElementById("signature-pad");
      const ctx = canvas.getContext("2d");
      let isDrawing = false;
      let lastX = 0;
      let lastY = 0;

      canvas.addEventListener("mousedown", startDrawing);
      canvas.addEventListener("mousemove", draw);
      canvas.addEventListener("mouseup", stopDrawing);
      canvas.addEventListener("mouseout", stopDrawing);

      // Touch events for mobile devices
      canvas.addEventListener("touchstart", startDrawing);
      canvas.addEventListener("touchmove", draw);
      canvas.addEventListener("touchend", stopDrawing);

      function startDrawing(e) {
        isDrawing = true;
        [lastX, lastY] = getCoordinates(e);
      }

      function draw(e) {
        if (!isDrawing) return;
        e.preventDefault();

        const [currentX, currentY] = getCoordinates(e);

        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(currentX, currentY);
        ctx.stroke();

        [lastX, lastY] = [currentX, currentY];
      }

      function stopDrawing() {
        isDrawing = false;
      }

      function getCoordinates(e) {
        if (e.type.includes("touch")) {
          const rect = canvas.getBoundingClientRect();
          return [
            e.touches[0].clientX - rect.left,
            e.touches[0].clientY - rect.top,
          ];
        }
        return [e.offsetX, e.offsetY];
      }

      // Clear signature
      document
        .getElementById("clearSignature")
        .addEventListener("click", () => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        });

      // Tambahkan fungsi validasi file
      function validateFile(file, maxSize, allowedTypes) {
        if (!file) return { valid: true, message: "" };

        // Cek ukuran file (dalam bytes)
        if (file.size > maxSize * 1024 * 1024) {
          return { valid: false, message: `Ukuran file melebihi ${maxSize}MB` };
        }

        // Cek tipe file
        if (!allowedTypes.includes(file.type)) {
          return {
            valid: false,
            message: `Tipe file tidak diizinkan. Gunakan: ${allowedTypes.join(
              ", "
            )}`,
          };
        }

        return { valid: true };
      }

      // Tambahkan fungsi validasi
      function validateForm() {
        // Validasi Nama
        const fullName = document.getElementById("fullName").value;
        if (!/^[A-Za-z\s']+$/.test(fullName)) {
          Swal.fire({
            icon: 'error',
            title: 'Format Nama Salah',
            text: 'Nama hanya boleh berisi huruf, spasi, dan tanda petik atas',
            confirmButtonColor: '#3498db'
          });
          return false;
        }

        // Validasi NIK
        const idNumber = document.getElementById("idNumber").value;
        if(idNumber){
        if (!/^\d{16}$/.test(idNumber)) {
          Swal.fire({
            icon: 'error',
            title: 'Format NIK Salah',
            text: 'NIK harus terdiri dari 16 digit angka',
            confirmButtonColor: '#3498db'
          });
          return false;
        }
        }

        // Validasi No HP
        const phone = document.getElementById("phone").value;
        if(phone){

          if (!/^(\+62|62|0)[0-9]{9,12}$/.test(phone)) {
            Swal.fire({
              icon: 'error',
              title: 'Format Nomor HP Salah',
              text: 'Masukkan nomor HP yang valid (contoh: 08xxxxxxxxxx)',
              confirmButtonColor: '#3498db'
            });
            return false;
          }
        }

        // Email validation removed since it's now optional

        return true;
      }

      // Update event listener submit
      document.getElementById("complaintForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        // Jalankan validasi
        if (!validateForm()) return;

        try {
          // Show loading state
          Swal.fire({
            title: 'Sedang Memproses',
            html: 'Mohon tunggu sebentar...',
            allowOutsideClick: false,
            showConfirmButton: false,
            willOpen: () => {
              Swal.showLoading();
            }
          });

          // Get signature data
          const signatureData = canvas.toDataURL();

          // Get file data
          const requiredDoc = document.getElementById("requiredDoc").files[0];
          const additionalDoc =
            document.getElementById("additionalDoc").files[0];

          // Convert files to base64
          const getBase64 = (file) => {
            return new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.readAsDataURL(file);
              reader.onload = () => resolve(reader.result);
              reader.onerror = (error) => reject(error);
            });
          };

          // Dalam event listener submit, tambahkan validasi sebelum upload
          if (requiredDoc) {
            const docValidation = validateFile(requiredDoc, 5, [
              "application/pdf",
              "image/jpeg",
              "image/jpg",
              "image/png",
            ]);
            if (!docValidation.valid) {
              alert("Dokumen Wajib: " + docValidation.message);
              return;
            }
          }

          if (additionalDoc) {
            const additionalValidation = validateFile(additionalDoc, 5, [
              "application/pdf",
              "image/jpeg",
              "image/jpg",
              "image/png",
            ]);
            if (!additionalValidation.valid) {
              alert("Dokumen Tambahan: " + additionalValidation.message);
              return;
            }
          }

          // Convert files to base64
          const requiredDocBase64 = requiredDoc
            ? await getBase64(requiredDoc)
            : null;
          const additionalDocBase64 = additionalDoc
            ? await getBase64(additionalDoc)
            : null;

          // Collect form data
          const formData = {
            formType: "pengaduan",
            fullName: document.getElementById("fullName").value,
            idNumber: document.getElementById("idNumber").value,
            phone: document.getElementById("phone").value,
            email: document.getElementById("email").value,
            accountNumber: document.getElementById("accountNumber").value,
            idAddress: document.getElementById("idAddress").value,
            idRT: document.getElementById("idRT").value,
            idRW: document.getElementById("idRW").value,
            idKelurahan: document.getElementById("idKelurahan").value,
            idKecamatan: document.getElementById("idKecamatan").value,
            domAddress: document.getElementById("domAddress").value,
            domRT: document.getElementById("domRT").value,
            domRW: document.getElementById("domRW").value,
            domKelurahan: document.getElementById("domKelurahan").value,
            domKecamatan: document.getElementById("domKecamatan").value,
            department: document.getElementById("department").value,
            product: document.getElementById("product").value,
            complaint: document.getElementById("complaint").value,
            signature: signatureData,
            requiredDocFile: requiredDoc
              ? {
                  data: requiredDocBase64,
                  name: requiredDoc.name,
                  type: requiredDoc.type,
                }
              : null,
            additionalDocFile: additionalDoc
              ? {
                  data: additionalDocBase64,
                  name: additionalDoc.name,
                  type: additionalDoc.type,
                }
              : null,
          };

          // Ganti XMLHttpRequest dengan fetch
          const response = await fetch(
            "https://script.google.com/macros/s/AKfycbxIy59x-kmgpiFkx9Su0mMW_rIZwoFa4tRGDLVKkfrycoTaqMhJq4cMxKJUEltCqsVkSA/exec",
            {
              redirect: "follow",
              method: "POST",
              body: JSON.stringify(formData),
              headers: {
                "Content-Type": "text/plain;charset=utf-8",
              },
              mode: "no-cors", // Tambahkan ini untuk mengatasi CORS
            }
          );

          // Since we're using no-cors, we can't read the response
          // Just assume success if no error is thrown
          await Swal.fire({
            icon: 'success',
            title: 'Berhasil!',
            text: 'Form pengaduan Anda telah berhasil dikirim',
            confirmButtonColor: '#3498db',
            timer: 3000,
            timerProgressBar: true
          });

          // Reset form
          document.getElementById("complaintForm").reset();
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        } catch (error) {
          console.error("Error:", error);
          Swal.fire({
            icon: 'error',
            title: 'Terjadi Kesalahan',
            text: 'Maaf, terjadi kesalahan saat mengirim data. Silakan coba lagi.',
            confirmButtonColor: '#3498db'
          });
        }
      });
    </script>
  </div>
</div>
